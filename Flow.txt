SEQUENCE FLOW TOÃ€N Bá»˜ Há»† THá»NG
ðŸŽ¯ CASE 1 â€” Há»c sinh báº¯t Ä‘áº§u thi
1ï¸âƒ£ Student Login

Frontend â†’ Supabase Auth
â†’ cÃ³ auth.uid()

2ï¸âƒ£ Student chá»n Grade 12

Frontend gá»i:

get_exam_templates_by_grade(12)

Query:

select *
from exam_templates
where grade_level = 12
order by created_at desc;
3ï¸âƒ£ Student chá»n Template #1

Frontend KHÃ”NG gá»i generate ngay.

TrÆ°á»›c tiÃªn gá»i:

check_in_progress_exam(template_id)
Query:
select id
from exams
where user_id = auth.uid()
and exam_template_id = p_template_id
and status = 'in_progress'
limit 1;
Náº¿u tá»“n táº¡i:

â†’ return exam_id
â†’ redirect vÃ o lÃ m tiáº¿p

Náº¿u khÃ´ng tá»“n táº¡i:

â†’ gá»i:

generate_exam_from_template(p_template_id)
ðŸŽ¯ CASE 2 â€” generate_exam_from_template
Transaction báº¯t Ä‘áº§u
STEP 1 â€” Insert exam instance
insert into exams (
    exam_template_id,
    user_id,
    grade_level,
    status,
    created_at
)
values (
    p_template_id,
    auth.uid(),
    template.grade_level,
    'in_progress',
    now()
)
returning id into v_exam_id;
STEP 2 â€” Láº¥y danh sÃ¡ch section
select *
from exam_template_sections
where exam_template_id = p_template_id
order by display_order;
STEP 3 â€” Vá»›i má»—i section:

Loop tá»«ng section:

STEP 3.1 â€” Select random question
select q.id
from questions q
join question_tags qt on qt.question_id = q.id
where
    q.grade_level = template.grade_level
    and qt.skill_code = section.skill_code
    and q.engine_type = section.engine_type
    and q.id not in (
        select eq.question_id
        from exams e
        join exam_questions eq on eq.exam_id = e.id
        where e.user_id = auth.uid()
        and e.created_at > now() - interval '1 day'
    )
order by random()
limit section.question_count;
STEP 3.2 â€” Fallback náº¿u khÃ´ng Ä‘á»§

Náº¿u sá»‘ row < required_count:

â†’ cháº¡y láº¡i query nhÆ°ng bá» Ä‘iá»u kiá»‡n chá»‘ng trÃ¹ng 1 ngÃ y.

STEP 3.3 â€” Insert vÃ o exam_questions
insert into exam_questions (
    exam_id,
    question_id,
    section_id,
    display_order
)
values (...)
STEP 4 â€” Return exam_id

Transaction commit.

ðŸŽ¯ CASE 3 â€” Student reload

Frontend gá»i:

get_exam_full(exam_id)
Query:
select
    s.id as section_id,
    s.title,
    q.id as question_id,
    q.content,
    q.engine_type,
    o.id as option_id,
    o.content as option_content,
    o.is_correct
from exam_questions eq
join questions q on q.id = eq.question_id
join exam_template_sections s on s.id = eq.section_id
left join options o on o.question_id = q.id
where eq.exam_id = p_exam_id
order by s.display_order, eq.display_order;
ðŸŽ¯ CASE 4 â€” Submit

RPC: submit_exam(p_exam_id)

STEP 1 â€” Check status
select status from exams where id = p_exam_id;

Náº¿u submitted â†’ reject.

STEP 2 â€” Cháº¥m Ä‘iá»ƒm

So sÃ¡nh:

selected_option_id

question_text_answers

STEP 3 â€” Update
update exams
set
    status = 'submitted',
    submitted_at = now(),
    score = v_score
where id = p_exam_id;


1ï¸âƒ£ Define UX flow hoÃ n chá»‰nh (khÃ´ng code)
2ï¸âƒ£ Define state machine
3ï¸âƒ£ Define error rendering strategy
4ï¸âƒ£ Define component breakdown
5ï¸âƒ£ Sau Ä‘Ã³ má»›i viáº¿t page.tsx